version: '3.8'

services:
  # Execution Layer (Geth)
  geth:
    image: ethereum/client-go:${GETH_VERSION:-v1.15.1}
    container_name: hoodi-geth
    restart: unless-stopped
    command:
      - --${NETWORK_NAME:-hoodi}
      - --datadir=/data/geth
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/jwt/jwtsecret
      - --http
      - --http.addr=${GETH_HTTP_ADDR:-127.0.0.1}
      - --http.port=${GETH_HTTP_PORT:-8545}
      - --http.api=eth,net,web3,engine
      - --ws
      - --ws.addr=${GETH_WS_ADDR:-127.0.0.1}
      - --ws.port=${GETH_WS_PORT:-8546}
      - --ws.api=eth,net,web3
      - --metrics
      - --metrics.addr=${GETH_METRICS_ADDR:-127.0.0.1}
      - --metrics.port=${GETH_METRICS_PORT:-6060}
      - --syncmode=${GETH_SYNC_MODE:-snap}
      - --cache=${GETH_CACHE:-4096}
      - --gcmode=${GETH_GC_MODE:-full}
      - --state.scheme=${GETH_STATE_SCHEME:-path}
      - --txlookuplimit=${GETH_TX_LOOKUP_LIMIT:-2350000}
      - --maxpeers=${GETH_MAX_PEERS:-50}
      - --nat=extip:${GETH_NAT_IP:-0.0.0.0}
    volumes:
      - ./data/geth:/data/geth
      - ./jwt:/jwt:ro
    ports:
      - "${GETH_HTTP_ADDR:-127.0.0.1}:${GETH_HTTP_PORT:-8545}:${GETH_HTTP_PORT:-8545}"
      - "${GETH_WS_ADDR:-127.0.0.1}:${GETH_WS_PORT:-8546}:${GETH_WS_PORT:-8546}"
      - "${GETH_P2P_TCP_PORT:-30303}:${GETH_P2P_TCP_PORT:-30303}"
      - "${GETH_P2P_UDP_PORT:-30303}:${GETH_P2P_UDP_PORT:-30303}/udp"
      - "${GETH_METRICS_ADDR:-127.0.0.1}:${GETH_METRICS_PORT:-6060}:${GETH_METRICS_PORT:-6060}"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:${GETH_HTTP_PORT:-8545}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 1m
    deploy:
      resources:
        limits:
          cpus: '${GETH_CPU_LIMIT:-4}'
          memory: ${GETH_MEMORY_LIMIT:-8G}
        reservations:
          cpus: '${GETH_CPU_RESERVATION:-2}'
          memory: ${GETH_MEMORY_RESERVATION:-4G}
    logging:
      driver: "${LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${LOGGING_MAX_SIZE:-100m}"
        max-file: "${LOGGING_MAX_FILE:-3}"
    networks:
      - hoodi
    env_file:
      - .env

  # Consensus Layer (Prysm Beacon)
  beacon:
    image: gcr.io/prysmaticlabs/prysm/beacon-chain:${BEACON_VERSION:-v5.3.0}
    container_name: hoodi-beacon
    restart: unless-stopped
    depends_on:
      geth:
        condition: service_healthy
      mev-boost:
        condition: service_healthy
    command:
      - --${NETWORK_NAME:-hoodi}
      - --datadir=/data/beacon
      - --execution-endpoint=http://geth:8551
      - --jwt-secret=/jwt/jwtsecret
      - --rpc-host=${BEACON_RPC_ADDR:-127.0.0.1}
      - --rpc-port=${BEACON_RPC_PORT:-4000}
      - --grpc-gateway-host=${BEACON_REST_ADDR:-127.0.0.1}
      - --grpc-gateway-port=${BEACON_REST_PORT:-5052}
      - --p2p-tcp-port=${BEACON_P2P_TCP_PORT:-13000}
      - --p2p-udp-port=${BEACON_P2P_UDP_PORT:-12000}
      - --p2p-max-peers=${BEACON_MAX_PEERS:-80}
      - --monitoring-host=${BEACON_METRICS_ADDR:-127.0.0.1}
      - --monitoring-port=${BEACON_METRICS_PORT:-8008}
      - --checkpoint-sync-url=${BEACON_CHECKPOINT_SYNC_URL:-https://hoodi.beaconstate.ethstaker.cc}
      - --accept-terms-of-use=true
      - --builder-grpc-endpoint=mev-boost:${MEV_BOOST_PORT:-3500}
      - --enable-debug-rpc-endpoints
    volumes:
      - ./data/beacon:/data/beacon
      - ./jwt:/jwt:ro
    ports:
      - "${BEACON_RPC_ADDR:-127.0.0.1}:${BEACON_RPC_PORT:-4000}:${BEACON_RPC_PORT:-4000}"
      - "${BEACON_REST_ADDR:-127.0.0.1}:${BEACON_REST_PORT:-5052}:${BEACON_REST_PORT:-5052}"
      - "${BEACON_METRICS_ADDR:-127.0.0.1}:${BEACON_METRICS_PORT:-8008}:${BEACON_METRICS_PORT:-8008}"
      - "${BEACON_P2P_TCP_PORT:-13000}:${BEACON_P2P_TCP_PORT:-13000}"
      - "${BEACON_P2P_UDP_PORT:-12000}:${BEACON_P2P_UDP_PORT:-12000}/udp"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:${BEACON_REST_PORT:-5052}/eth/v1/node/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 2m
    deploy:
      resources:
        limits:
          cpus: '${BEACON_CPU_LIMIT:-4}'
          memory: ${BEACON_MEMORY_LIMIT:-16G}
        reservations:
          cpus: '${BEACON_CPU_RESERVATION:-2}'
          memory: ${BEACON_MEMORY_RESERVATION:-8G}
    logging:
      driver: "${LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${LOGGING_MAX_SIZE:-100m}"
        max-file: "${LOGGING_MAX_FILE:-3}"
    networks:
      - hoodi
    env_file:
      - .env

  # Validator Client (Prysm)
  validator:
    image: gcr.io/prysmaticlabs/prysm/validator:${VALIDATOR_VERSION:-v5.3.0}
    container_name: hoodi-validator
    restart: unless-stopped
    depends_on:
      beacon:
        condition: service_healthy
    command:
      - --${NETWORK_NAME:-hoodi}
      - --accept-terms-of-use=true
      - --datadir=/data/validator
      - --beacon-rpc-provider=beacon:${BEACON_RPC_PORT:-4000}
      - --beacon-rpc-gateway-provider=http://beacon:${BEACON_REST_PORT:-5052}
      - --wallet-dir=/data/validator
      - --wallet-password-file=/secrets/wallet-password.txt
      - --suggested-fee-recipient=${FEE_RECIPIENT:-0x0000000000000000000000000000000000000000}
      - --monitoring-host=${VALIDATOR_METRICS_ADDR:-127.0.0.1}
      - --monitoring-port=${VALIDATOR_METRICS_PORT:-8009}
      - --enable-doppelg√§nger-protection=${VALIDATOR_DOPPELGANGER_PROTECTION:-true}
      - --graffiti=${VALIDATOR_GRAFFITI:-hoodi-validator}
    volumes:
      - ./data/validator:/data/validator
      - ./secrets:/secrets:ro
    ports:
      - "${VALIDATOR_METRICS_ADDR:-127.0.0.1}:${VALIDATOR_METRICS_PORT:-8009}:${VALIDATOR_METRICS_PORT:-8009}"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:${VALIDATOR_METRICS_PORT:-8009}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 2m
    deploy:
      resources:
        limits:
          cpus: '${VALIDATOR_CPU_LIMIT:-2}'
          memory: ${VALIDATOR_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${VALIDATOR_CPU_RESERVATION:-1}'
          memory: ${VALIDATOR_MEMORY_RESERVATION:-2G}
    logging:
      driver: "${LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${LOGGING_MAX_SIZE:-100m}"
        max-file: "${LOGGING_MAX_FILE:-3}"
    networks:
      - hoodi
    env_file:
      - .env

  # MEV-Boost (Multiple Relays)
  mev-boost:
    image: flashbots/mev-boost:${MEV_BOOST_VERSION:-v1.7}
    container_name: hoodi-mev-boost
    restart: unless-stopped
    command:
      - -addr=0.0.0.0:${MEV_BOOST_PORT:-3500}
      - -mainnet=false
      - -relay-check
      - -relays=${MEV_RELAYS:-https://0xaa58208899c6105603b74396734a6263cc7d947f444f396a90f7b7d3e65d102aec7e5e5291b27e08d02c50a050825c2f@hoodi.titanrelay.xyz}
    ports:
      - "${MEV_BOOST_PORT:-3500}:${MEV_BOOST_PORT:-3500}"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:${MEV_BOOST_PORT:-3500}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 1m
    deploy:
      resources:
        limits:
          cpus: '${MEV_CPU_LIMIT:-1}'
          memory: ${MEV_MEMORY_LIMIT:-2G}
        reservations:
          cpus: '${MEV_CPU_RESERVATION:-0.5}'
          memory: ${MEV_MEMORY_RESERVATION:-1G}
    logging:
      driver: "${LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${LOGGING_MAX_SIZE:-100m}"
        max-file: "${LOGGING_MAX_FILE:-3}"
    networks:
      - hoodi
    env_file:
      - .env

networks:
  hoodi:
    driver: bridge
